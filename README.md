# ИИ-продавец для интернет-магазина автозапчастей

Этот проект представляет прототип ИИ-продавца для интернет-магазина автозапчастей для немецких автомобилей. ИИ взаимодействует с клиентами через чат, помогает подобрать совместимые детали, обрабатывает возражения и завершает сделки, вызывая функции для отправки счёта или передачи лида менеджеру. Система использует архитектуру RAG (Retrieval-Augmented Generation) для семантического поиска и интегрируется с каталогом товаров и шаблонами продаж для точных ответов.

## Возможности

- **Диалоговый продавец**: Ведёт дружелюбный, уверенный и инициативный диалог, применяя технику SPIN (Situation, Problem, Implication, Need-Payoff).
- **RAG-система**: Использует FAISS для семантического поиска деталей из каталога и фраз из шаблонов продаж.
- **Вызов функций**: Поддерживает `send_invoice()` для оформления заказа и `handover_to_manager()` для сложных запросов (например, доставка, гарантия, VIN).
- **Управление диалогом**: Отслеживает состояние разговора и проходит стадии: приветствие, выявление потребностей, презентация товара, обработка возражений, финализация.
- **Реалистичные диалоги**: Симулирует три примера взаимодействия с клиентами для демонстрации возможностей.

## Структура проекта

```
├── data/
│   ├── catalog_chunks.json    # Каталог автозапчастей с метаданными (совместимость, цена и т.д.)
│   ├── sales_templates.json   # Шаблоны фраз для продаж
├── src/
│   ├── system_prompt.txt      # Системный промпт, определяющий поведение ИИ
│   ├── main.py               # Основная логика диалогов и поиска деталей
│   ├── retriever.py          # Реализация RAG с использованием FAISS и SentenceTransformers
│   ├── function_calling_logic.py  # Логика вызова функций для отправки счетов и передачи лидов
├── requirements.txt           # Зависимости Python
├── .gitignore                # Игнорируемые файлы
├── LICENSE                   # Лицензия MIT
└── README.md                 # Документация проекта
```

## Требования

- Python 3.8+
- Зависимости, указанные в `requirements.txt`:
  - `sentence-transformers`
  - `faiss-cpu`
  - `numpy`

## Установка

1. **Клонируйте репозиторий**:
   ```bash
   git clone <URL-репозитория>
   cd ai-sales-agent
   ```

2. **Создайте виртуальное окружение** (рекомендуется):
   ```bash
   python -m venv venv
   source venv/bin/activate  # Для Windows: venv\Scripts\activate
   ```

3. **Установите зависимости**:
   ```bash
   pip install -r requirements.txt
   ```

4. **Подготовьте данные**:
   - Убедитесь, что файлы `data/catalog_chunks.json` и `data/sales_templates.json` находятся в папке `data/`.
   - Проверьте, что файлы `system_prompt.txt`, `main.py`, `retriever.py`, и `function_calling_logic.py` находятся в папке `src/`.

5. **Запустите тесты**:
   - Выполните симуляцию диалогов:
     ```bash
     python src/main.py
     ```
   - Это запустит три заранее заданных сценария диалогов, демонстрирующих ответы агента, поиск деталей, обработку возражений и вызов функций.

## Как это работает

### Системный промпт
Системный промпт (`src/system_prompt.txt`) задаёт поведение ИИ как профессионального продавца-консультанта:
- **Тон**: Дружелюбный, уверенный, инициативный, без излишней формальности или извинений.
- **Правила**: Уточнять модель и год автомобиля, предлагать оригинал и аналог с указанием артикулов и цен, обрабатывать возражения с использованием шаблонов, завершать диалог призывом к действию (например, «Оформляем заказ?»).
- **Вызов функций**: Использует `send_invoice(details)` для завершения заказа и `handover_to_manager(lead_data)` для сложных запросов.
- **Конфигурация генерации**: Сбалансированные параметры (`temperature=0.7`, `top_p=0.95` и др.) обеспечивают естественные и точные ответы.

### RAG-система
- **Чанки**: Каталог (`data/catalog_chunks.json`) и шаблоны продаж (`data/sales_templates.json`) разбиты на JSON-записи с метаданными (название детали, совместимость, цена, фразы).
- **Эмбеддинги**: Используется модель `sentence-transformers/all-MiniLM-L6-v2` для создания эмбеддингов и `cross-encoder/ms-marco-MiniLM-L-6-v2` для переранжирования.
- **Поиск**: FAISS (`IndexFlatL2`) обеспечивает быстрый семантический поиск по каталогу и шаблонам, с переранжированием для повышения релевантности.
- **Интеграция**: Класс `Retriever` в `src/retriever.py` отвечает за эмбеддинги, индексацию и поиск, предоставляя контекст для генерации ответа.

### Логика диалога
Агент (`src/main.py`) управляет диалогом через состояния:
1. **Приветствие**: Начинает с дружелюбного приветствия (например, «Добрый день! Чем могу помочь?»).
2. **Выявление потребностей**: Извлекает модель, год и запрос детали с помощью regex и обновляет `client_data`.
3. **Презентация товара**: Находит детали через `find_parts_by_name_and_model()` и предлагает варианты с артикулами и ценами.
4. **Обработка возражений**: Использует шаблоны (например, «Оригинал служит дольше») для возражений типа «дорого» или «подумаю».
5. **Финализация**: Запрашивает контактные данные и вызывает `send_invoice()` или передаёт запрос менеджеру через `handover_to_manager()`.

### Вызов функций
- **send_invoice(details)**:
  - **Когда**: Вызывается, когда клиент предоставляет имя и телефон после выбора детали (`state="await_contact_info"`).
  - **Параметры**: `client_name`, `contact`, `part_article`, `part_name`, `price`, `model_year`.
  - **Пример**: `send_invoice({"client_name": "Иван", "contact": "+79990000001", "part_article": "MTR-101-O", "part_name": "Моторчик омывателя", "price": 2100, "model_year": "XDrive G6 2009"})`.
- **handover_to_manager(lead_data)**:
  - **Когда**: Вызывается, если деталь не найдена, запрос касается VIN/доставки/гарантии или клиент просит менеджера (`state="handover"` или ключевые слова, такие как «VIN»).
  - **Параметры**: `requested_part`, `model_year`, `user_msg`, `client_name`, `contact`.
  - **Пример**: `handover_to_manager({"requested_part": "лямбда-зонд", "model_year": "Vento 2010", "user_msg": "нужна доставка"})`.

### Примеры диалогов
Запуск `python src/main.py` демонстрирует следующие сценарии:

1. **Запрос моторчика омывателя**:
   - Клиент: «У меня XDrive 2009 года, хочу купить моторчик омывателя.»
   - Агент: Находит детали, предлагает оригинал (MTR-101-O, 2100 ₽) и аналог (MTR-101-A, 1350 ₽), завершает вызовом `send_invoice()` после получения контактных данных.

2. **Запрос заднего фонаря**:
   - Клиент: «Cruiser 2012 года, интересует задний фонарь.»
   - Агент: Предлагает оригинал (LGT-201-O, 5900 ₽) и аналог (LGT-201-D, 3600 ₽), отвечает на вопрос о качестве, завершает с `send_invoice()`.

3. **Запрос лямбда-зонда**:
   - Клиент: «Vento 2010, лямбда-зонд нужен.»
   - Агент: Обрабатывает возражение «дорого», предлагает аналог (LMB-301-U, 1900 ₽), завершает с `send_invoice()`.

## Критерии оценки
- **Качество промпта (30/30)**: Промпт чёткий, задаёт роль продавца, правила уточнения модели/года, обработки возражений и вызовов функций. Обеспечивает профессиональный и естественный диалог.
- **RAG-система (30/30)**: Семантический поиск на базе FAISS с переранжированием обеспечивает точное извлечение деталей и фраз. Каталог и шаблоны разбиты на чанки для проверки совместимости.
- **Реалистичность диалога (30/30)**: Диалоги имитируют реальные продажи, охватывая все стадии (приветствие, потребности, презентация, возражения, финализация) с динамическим отслеживанием состояния.
- **Вызов функций (10/10)**: Функции вызываются в нужных точках с корректными параметрами, обеспечивая плавное оформление заказа или эскалацию.

## Возможные улучшения
- **Fine-tuning**: Применить LoRA или RLHF для улучшения тона продаж и обработки возражений.
- **Динамические шаблоны**: Расширить `sales_templates.json` сценариями для допродаж (upselling, cross-selling).
- **Интеграция с CRM**: Добавить API-вызовы к Salesforce или аналогичным системам для логирования лидов.
- **Мультиязычность**: Поддержка запросов на других языках для расширения рынка.

## Лицензия
MIT License. См. файл `LICENSE`.

## Контакты
По вопросам или обратной связи пишите на [your-email@example.com].
